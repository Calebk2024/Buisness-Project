<html>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
<head>
    <style>

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        h2 {
            color: black;
            margin-top:60px;
            text-align:center;
            font-size:30px;
        }
        table {
            width: 100%;
            height:20%;
            margin-top: 20px;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid rgb(52, 46, 46);
            padding: 7px;
            text-align: left;
        }
        th {
            background-color:white;
        }
        nav {
            background-color: black;
            overflow: hidden;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
        }
        nav a {
            float: left;
            display: block;
            color: white;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
        }
        nav a:hover {
            background-color: #ddd;
            color:blue;
        }
        div#result{
            box-sizing: border-box; 
            border: 2px solid #999;
            padding: 20px; 
            margin: 0 auto;
            width: 80%; 
            font-family: 'Arial', sans-serif;
            font-size: 16px;
            color: #333;
            margin: 20px auto 0;
            text-align: center;
        }
        

    </style>
</head>
<body>
    <nav>
        <a href="index.html">Back to homepage</a>
        <a href="user.html">Back to user logging</a>
        <a href="visualizations.html">Categorial Expense Visualization</a>
        <a href="visualizations2.html">Daily Expense Visualization</a>
    </nav>
    
    <h2>Expense Table</h2>
    <table border="1" id="dataTable">
        <thead>
            <tr>
                <th>Description</th>
                <th>Amount</th>
                <th>Category</th>
                <th>Date</th>
            </tr>
        </thead>
    </table>
    <table border="1" id="all">
        <thead>
            <tr>
                <th>Total</th>
                <th>Food Percentage</th>
                <th>Entertainment Percentage</th>
                <th>Housing Percentage</th>
                <th>Transportation Percentage</th>
                <th>Utilities Percentage</th>
                <th>Other Percentage</th>
            </tr>
        </thead>
    </table>
    <table border="1" id="two">
        <thead>
            <tr>
                <th>Average amount spent per day</th>
                <th>Average amount spent per week</th>
            </tr>
        </thead>
    </table>

    <script>
        var myArray = JSON.parse(localStorage.getItem("myArray")) || [];
        console.log(myArray);
        function addRowToTable(name, amount, category, date) {
            var table = document.getElementById('dataTable');
            var newRow = table.insertRow(table.rows.length);
            var cell1 = newRow.insertCell(0);
            var cell2 = newRow.insertCell(1);
            var cell3 = newRow.insertCell(2);
            var cell4 = newRow.insertCell(3);
            cell1.innerHTML = name;
            cell2.innerHTML = amount + " $";
            cell4.innerHTML=date.substring(5)+"-"+date.substring(0,4);
            cell3.innerHTML = category;
        }
        function updateTable() {
            
            var table = document.getElementById('dataTable');
            
            for (var i = 0; i < myArray.length; i++) {
                addRowToTable(myArray[i].description, myArray[i].amount, myArray[i].category, myArray[i].transactionDate);
            }
        }
        updateTable();
        add=0;
        food=0;
        enter=0;
        house=0;
        trans=0;
        util=0;
        local=[];
        oth=0;
        for (var i = 0; i < myArray.length; i++) {
            add+=Number(myArray[i]["amount"]);
            local.push(myArray[i]["transactionDate"]);
            if(myArray[i]["category"]=="food"){
                food+=Number(myArray[i]["amount"]);
            }
            if(myArray[i]["category"]=="housing"){
                house+=Number(myArray[i]["amount"]);
            }
            if(myArray[i]["category"]=="transportation"){
                trans+=Number(myArray[i]["amount"]);
            }
            if(myArray[i]["category"]=="utilities"){
                util+=Number(myArray[i]["amount"]);
            }
            if(myArray[i]["category"]=="entertainment"){
                enter+=Number(myArray[i]["amount"]);
            }
            if(myArray[i]["category"]=="other"){
                oth+=Number(myArray[i]["amount"]);
            }
        }
        function samedates(Array){
            const same = [];
            let counter=0;
            Array.forEach(dateStr => {
                const dateObj = new Date(dateStr);
                dateObj.setDate(dateObj.getDate() + 1);
                const year = dateObj.getFullYear();
                const month = dateObj.getMonth() + 1; 
                const day = dateObj.getDate();
                const dateKey = `${year}-${month < 10 ? '0' : ''}${month}-${day < 10 ? '0' : ''}${day}`;
                bool=true;
                for (let i = 0; i < same.length; i++) {
                    if(dateKey==same[i]){
                        bool=false;
                    }
                }
                if(bool){
                    same.push(dateKey);
                    counter+=1;
                }
            });
            return counter;
            
        }
        function sameweek(dateArray) {
            const group = [];
            let counter=0;
            dateArray.forEach(date=> {
                const dateObj = new Date(date);
                dateObj.setDate(dateObj.getDate() + 1);
                
                const year = dateObj.getFullYear();
                const weekNum = getWeek(dateObj)-1;
                const weekKey = `${year}-W${weekNum< 10 ? '0' : ''}${weekNum}`;
                bool=true;
                for (let i = 0; i < group.length; i++) {
                    if(weekKey==group[i]){
                        bool=false;
                    }
                }
                if(bool){
                    group.push(weekKey)
                    counter+=1
                }
            });
            return counter;
        }
        function getWeek(date) {
            const target = new Date(date.valueOf());
            const day = (date.getDay() + 7) % 7;
            target.setDate(target.getDate() - day + 3);
            const first = target.valueOf();
            target.setMonth(0, 1);
            if (target.getDay() !== 0) {
                target.setMonth(0, 1 + ((0 - target.getDay()) + 7) % 7);
            }
            return 1 + Math.ceil((first - target) / 604800000);
        }
        var table = document.getElementById('all');
        var newRow = table.insertRow(table.rows.length);
        var cell1 = newRow.insertCell(0);
        var cell2 = newRow.insertCell(1);
        var cell3 = newRow.insertCell(2);
        var cell4 = newRow.insertCell(3)
        var cell5 = newRow.insertCell(4);
        var cell6 = newRow.insertCell(5);
        var cell7 = newRow.insertCell(6);
        cell1.innerHTML = add+" dollars";
        cell2.innerHTML = parseFloat(food/add);
        cell3.innerHTML = parseFloat(enter/add);
        cell4.innerHTML = parseFloat(house/add);
        cell5.innerHTML = parseFloat(trans/add);
        cell6.innerHTML = parseFloat(util/add);
        cell7.innerHTML=parseFloat(oth/add);
        localStorage.setItem("fpercent", cell2.innerHTML);
        localStorage.setItem("epercent", cell3.innerHTML);
        localStorage.setItem("hpercent", cell4.innerHTML);
        localStorage.setItem("tpercent", cell5.innerHTML);
        localStorage.setItem("upercent", cell6.innerHTML);
        localStorage.setItem("opercent", cell7.innerHTML);
        var t=document.getElementById('two');
        var nw=t.insertRow(t.rows.length);
        var cell1 = nw.insertCell(0);
        var cell2 = nw.insertCell(1);
        cell1.innerHTML=parseFloat(add/samedates(local));
        cell2.innerHTML=parseFloat(add/sameweek(local));
        
        localStorage.setItem("food", food);
        localStorage.setItem("enter", enter);
        localStorage.setItem("house", house);
        localStorage.setItem("trans", trans);
        localStorage.setItem("util", util);
        localStorage.setItem("oth", oth);
        var wBudget=localStorage.getItem("weekbudget");
        var mBudget=localStorage.getItem("monthbudget");

        function budget(){
            var weekcounter=0;
            var monthcounter=0;
            weekArray={};
            monthArray={};
            myArray.forEach((t)=> {
                var am=t.amount;
                var tr=t.transactionDate;
                var obj = new Date(tr);
                obj.setDate(obj.getDate() + 1);
                key=getWeek(obj)-1;
                key2=obj.getMonth()+1;
                if(weekArray[key]){
                    weekArray[key]+=parseFloat(am);
                }
                else{
                    weekArray[key]=parseFloat(am);
                }
                if(monthArray[key2]){
                    monthArray[key2]+=parseFloat(am);
                }
                else{
                    monthArray[key2]=parseFloat(am);
                }
                
                if(weekArray[key]>parseFloat(wBudget)&&weekcounter==0){
                    alert("You have exceeded your weekly budget for week "+key);
                    weekcounter+=1
                }
                if(monthArray[key2]>parseFloat(mBudget)&&monthcounter==0){
                    alert("You have exceeded your monthly budget for month "+key2);
                    monthcounter+=1
                }
            });
        }
        budget();
    </script>
</body>
</html>